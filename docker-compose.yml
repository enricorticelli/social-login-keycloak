services:
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: keycloak-identity
    command:
      - start-dev
      - --features=token-exchange,admin-fine-grained-authz
      - --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8181:8080"
    volumes:
      - ./keycloak/realm-social-demo.json:/opt/keycloak/data/import/realm-social-demo.json:ro

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: backend-net10
    depends_on:
      - keycloak
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      Keycloak__Authority: http://keycloak:8080
      Keycloak__Realm: social-demo
      Keycloak__ClientId: social-login-backend
      Keycloak__ClientSecret: backend-secret
      Keycloak__Audience: social-login-backend
      AllowedCorsOrigins__0: http://localhost:3000
    ports:
      - "5188:8080"

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: frontend-nextjs
    depends_on:
      - backend
    environment:
      NEXT_PUBLIC_API_BASE: http://backend:8080
      KEYCLOAK_TOKEN_URL: http://keycloak:8080/realms/social-demo/protocol/openid-connect/token
      MOCK_SOCIAL_CLIENT: mock-social-app
      MOCK_SOCIAL_USERNAME: demo
      MOCK_SOCIAL_PASSWORD: demo
    ports:
      - "3000:3000"
